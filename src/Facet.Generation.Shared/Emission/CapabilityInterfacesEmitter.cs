using System.Collections.Immutable;
using System.Linq;
using System.Text;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;

namespace Facet.Extensions.EFCore.Generators.Emission;

/// <summary>
/// Emits capability interfaces that represent navigation property inclusion capabilities.
/// </summary>
public static class CapabilityInterfacesEmitter
{
    public static void Emit(SourceProductionContext context, ModelRoot efModel, ImmutableArray<FacetDtoInfo> facetDtos)
    {
        foreach (var contextModel in efModel.Contexts)
        {
            foreach (var entity in contextModel.Entities)
            {
                // Find matching DTO (handle global:: prefix)
                var entityClr = entity.Clr?.Replace("global::", "");
                var matchingDto = facetDtos.FirstOrDefault(dto =>
                {
                    var dtoEntityName = dto.EntityTypeName?.Replace("global::", "");
                    return string.Equals(dtoEntityName, entityClr, System.StringComparison.OrdinalIgnoreCase) ||
                           string.Equals(dtoEntityName, entity.Clr, System.StringComparison.OrdinalIgnoreCase);
                });

                if (matchingDto == null) continue;

                GenerateCapabilityInterfaces(context, entity, matchingDto);
            }
        }
    }

    private static void GenerateCapabilityInterfaces(SourceProductionContext context, EntityModel entity, FacetDtoInfo dtoInfo)
    {
        if (!entity.Navigations.Any()) return;

        var entityName = GetSimpleTypeName(entity.Clr ?? entity.Name);
        var sb = new StringBuilder();

        // Generate file header
        sb.AppendLine("// <auto-generated />");
        sb.AppendLine("#nullable enable");
        sb.AppendLine();
        sb.AppendLine($"namespace {dtoInfo.DtoNamespace};");
        sb.AppendLine();

        // Generate capability interfaces for each navigation
        foreach (var navigation in entity.Navigations)
        {
            var navName = navigation.Name;
            var targetEntityName = GetSimpleTypeName(navigation.Target);
            var interfaceName = $"I{entityName}With{navName}<TShape>";

            sb.AppendLine($"/// <summary>");
            sb.AppendLine($"/// Capability interface for {entityName} with {navName} navigation included.");
            sb.AppendLine($"/// </summary>");
            sb.AppendLine($"/// <typeparam name=\"TShape\">The shape of the included {navName} navigation.</typeparam>");
            sb.AppendLine($"public interface {interfaceName} : I{entityName}Shape");
            sb.AppendLine("{");

            if (navigation.IsCollection)
            {
                sb.AppendLine($"    /// <summary>");
                sb.AppendLine($"    /// The included {navName} collection.");
                sb.AppendLine($"    /// </summary>");
                sb.AppendLine($"    System.Collections.Generic.IReadOnlyList<TShape> {navName} {{ get; }}");
            }
            else
            {
                sb.AppendLine($"    /// <summary>");
                sb.AppendLine($"    /// The included {navName} navigation.");
                sb.AppendLine($"    /// </summary>");
                sb.AppendLine($"    TShape {navName} {{ get; }}");
            }

            sb.AppendLine("}");
            sb.AppendLine();
        }

        var sourceText = SourceText.From(sb.ToString(), System.Text.Encoding.UTF8);
        context.AddSource($"{entityName}CapabilityInterfaces.g.cs", sourceText);
    }

    private static string GetSimpleTypeName(string fullTypeName)
    {
        var lastDot = fullTypeName.LastIndexOf('.');
        return lastDot >= 0 ? fullTypeName.Substring(lastDot + 1) : fullTypeName;
    }
}
