<Project>
  <UsingTask TaskName="ExportEfModelTask"
             AssemblyFile="$(MSBuildThisFileDirectory)..\bin\Debug\net8.0\Facet.Extensions.EFCore.dll" />

  <PropertyGroup>
    <FacetEfExportEnabled Condition="'$(FacetEfExportEnabled)' == ''">true</FacetEfExportEnabled>
    <FacetEfModelJson Condition="'$(FacetEfModelJson)' == ''">$(IntermediateOutputPath)efmodel.json</FacetEfModelJson>
    <FacetEfContextAssemblyPath Condition="'$(FacetEfContextAssemblyPath)' == ''">$(TargetPath)</FacetEfContextAssemblyPath>
    <FacetEfContextTypes Condition="'$(FacetEfContextTypes)' == ''"></FacetEfContextTypes>
    <FacetMaxChainDepth Condition="'$(FacetMaxChainDepth)' == ''">3</FacetMaxChainDepth>
    <FacetEnableDebugOutput Condition="'$(FacetEnableDebugOutput)' == ''">false</FacetEnableDebugOutput>
  </PropertyGroup>

  <Target Name="Facet_ExportEfModel"
          Condition="'$(FacetEfExportEnabled)' == 'true' AND Exists('$(FacetEfContextAssemblyPath)')"
          AfterTargets="CoreCompile"
          Inputs="$(FacetEfContextAssemblyPath)"
          Outputs="$(FacetEfModelJson)">
    <ExportEfModelTask AssemblyPath="$(FacetEfContextAssemblyPath)"
                       ContextTypes="$(FacetEfContextTypes)"
                       OutputPath="$(FacetEfModelJson)" />
    <ItemGroup>
      <AdditionalFiles Include="$(FacetEfModelJson)" />
    </ItemGroup>
    <Message Text="Generated efmodel.json for source generation" Importance="high" />
  </Target>

  <!-- Ensure efmodel.json is available for source generators on subsequent builds -->
  <Target Name="Facet_IncludeEfModelForSourceGen"
          BeforeTargets="GenerateSourceFiles"
          Condition="Exists('$(FacetEfModelJson)')">
    <ItemGroup>
      <AdditionalFiles Include="$(FacetEfModelJson)" />
    </ItemGroup>
  </Target>
</Project>
