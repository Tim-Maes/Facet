// <auto-generated />
#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.EntityFrameworkCore;
using Facet.Extensions;

namespace Facet.Extensions.EFCore.Tests.TestData;

/// <summary>
/// Fluent builder for Category with navigation inclusion.
/// </summary>
public sealed class FacetCategoryBuilder<TShape>
    where TShape : class
{
    private readonly IQueryable<Facet.Extensions.EFCore.Tests.TestData.Category> _query;
    private readonly List<string> _includes = new();

    public FacetCategoryBuilder(IQueryable<Facet.Extensions.EFCore.Tests.TestData.Category> query)
    {
        _query = query;
    }

    /// <summary>
    /// Include the Products navigation in the query.
    /// </summary>
    public FacetCategoryBuilder<ICategoryWithProducts<IProductShape>> WithProducts()
    {
        var newQuery = _query.Include(x => x.Products);
        var newBuilder = new FacetCategoryBuilder<ICategoryWithProducts<IProductShape>>(newQuery);
        newBuilder._includes.AddRange(_includes);
        newBuilder._includes.Add("Products");
        return newBuilder;
    }

    /// <summary>
    /// Include the Products navigation with nested navigation configuration.
    /// </summary>
    public FacetCategoryBuilder<ICategoryWithProducts<TNestedShape>> WithProducts<TNestedShape>(
        Func<FacetProductBuilder<IProductShape>, FacetProductBuilder<TNestedShape>> configure)
        where TNestedShape : class
    {
        // This would require more complex EF Include handling for nested paths
        throw new NotImplementedException("Nested navigation configuration not yet implemented");
    }

    /// <summary>
    /// Get a single Category by ID.
    /// </summary>
    public async Task<TShape?> GetByIdAsync(object id, CancellationToken cancellationToken = default)
    {
        // For now, use simple Id-based filtering
        // TODO: Enhance to use EF metadata for primary key discovery
        var query = _query.Where(e => EF.Property<object>(e, "Id") == id);

        // Use SelectFacet to project to TShape
        return await query.SelectFacet<TShape>().FirstOrDefaultAsync(cancellationToken);
    }

    /// <summary>
    /// Execute the query and return a list of Category shapes.
    /// </summary>
    public async Task<List<TShape>> ToListAsync(CancellationToken cancellationToken = default)
    {
        // Use SelectFacet to project to TShape and execute query
        return await _query.SelectFacet<TShape>().ToListAsync(cancellationToken);
    }

    /// <summary>
    /// Execute the query and return the first Category or default.
    /// </summary>
    public async Task<TShape?> FirstOrDefaultAsync(CancellationToken cancellationToken = default)
    {
        // Use SelectFacet to project to TShape and execute query
        return await _query.SelectFacet<TShape>().FirstOrDefaultAsync(cancellationToken);
    }
}
